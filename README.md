# Depflow

## 项目概述
Task Dependency Graph 是一个基于 Python 的 `tkinter` 库开发的可视化工具，用于创建和管理任务依赖图。用户可以通过图形界面创建代表 Python 脚本的节点，建立节点间的依赖关系，并按照拓扑排序的结果顺序执行这些脚本。此外，用户还能为节点关联本地 Python 文件或直接输入 Python 代码。

## 功能特性
1. **节点创建**：点击 “Create Node” 按钮，可在画布上创建新节点，每个节点默认命名为 `scriptX.py`。
2. **节点操作**：
    - 使用鼠标中键拖动节点到画布任意位置。
    - 右键点击节点，可选择关联本地 Python 文件或直接输入 Python 代码。
3. **依赖关系建立**：使用鼠标左键从一个节点拖动到另一个节点，建立脚本间的依赖关系。
4. **脚本执行**：点击 “Execute All Files” 按钮，工具会对脚本进行拓扑排序，并按顺序执行，若图中存在循环依赖则输出错误信息。

## 安装与使用

### 安装
确保你已经安装了 Python 环境。本工具仅依赖 Python 标准库，无需额外安装其他库。

### 使用步骤
1. **启动程序**：运行 Python 脚本，打开可视化工具窗口。
2. **创建节点**：点击 “Create Node” 按钮，在画布上创建新节点。
3. **关联文件或代码**：右键点击节点，在弹出的对话框中选择 “是否选择 Python 文件？否则输入代码”。若选择 “是”，可通过文件选择对话框选择本地 Python 文件；若选择 “否”，可直接输入 Python 代码，代码将保存到临时文件中。
4. **拖动节点**：使用鼠标中键点击并拖动节点到所需位置。
5. **建立依赖关系**：使用鼠标左键点击一个节点，然后拖动到另一个节点，释放鼠标左键建立依赖关系。
6. **执行脚本**：点击 “Execute All Files” 按钮，工具会对脚本进行拓扑排序并按顺序执行。

## 代码结构
### 全局变量
- `graph`：字典，存储节点间的依赖关系。
- `nodes`：列表，存储画布上的所有节点。
- `node_names`：字典，存储节点的名称。
- `node_labels`：字典，存储节点的标号。
- `node_files`：字典，存储每个节点对应的文件或代码。
- `current_dragging`：当前正在拖动的节点。
- `start_node`：开始建立依赖关系的节点。
- `line`：用于绘制依赖关系的连线。
- `DISTANCE_THRESHOLD`：建立依赖关系的距离阈值。
- `SELECTION_THRESHOLD`：节点选中范围的阈值。

### 主要函数
1. **`topological_sort(graph)`**：对图进行拓扑排序，返回脚本的执行顺序。若图中存在循环依赖，抛出 `ValueError` 异常。
2. **`execute_file(file)`**：执行指定的 Python 脚本，并输出执行结果。
3. **`execute_all_files()`**：对所有脚本进行拓扑排序，并按顺序执行。
4. **`find_node_in_range(x, y)`**：查找指定坐标范围内的节点。
5. **`on_right_click(event)`**：处理节点的右键点击事件，允许用户关联文件或输入代码。
6. **`create_node()`**：创建新节点，并绑定鼠标事件。
7. **`start_drag(event)`**：开始拖动节点。
8. **`drag(event)`**：拖动节点。
9. **`end_drag(event)`**：结束拖动节点。
10. **`start_connect(event)`**：开始建立依赖关系。
11. **`draw_line(event)`**：绘制依赖关系的连线。
12. **`end_connect(event)`**：结束建立依赖关系，根据距离阈值判断是否建立连接。

## 注意事项
- 确保所有关联的 Python 脚本文件或输入的代码能在当前环境中正常执行。
- 若图中存在循环依赖，拓扑排序将失败，工具会输出错误信息。
- 直接输入的代码会保存到临时文件中，程序结束后临时文件可能被系统清理。

## 贡献
如果你发现任何问题或有改进建议，请随时提交 Issue 或 Pull Request。