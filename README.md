# Depflow

## 简介
这是一个使用 Python 的 `tkinter` 库开发的可视化工具，用于创建和管理任务依赖图。用户可以在画布上创建节点，每个节点代表一个 Python 脚本文件。通过拖动和连接节点，用户可以定义脚本之间的依赖关系。工具支持拓扑排序，确保脚本按照依赖顺序执行。

## 功能特性
1. **节点创建**：用户可以通过点击 "Create Node" 按钮在画布上创建新的节点，每个节点对应一个 Python 脚本文件。
2. **节点拖动**：用户可以使用鼠标中键拖动节点到画布上的任意位置。
3. **依赖关系建立**：用户可以使用鼠标左键从一个节点拖动到另一个节点来建立脚本之间的依赖关系。
4. **拓扑排序执行**：点击 "Execute All Files" 按钮，工具会对脚本进行拓扑排序，并按顺序执行这些脚本。

## 安装与使用

### 安装
确保你已经安装了 Python 环境。该工具仅依赖于 Python 标准库，无需额外安装其他库。

### 使用步骤
1. **启动程序**：运行 Python 脚本，即可打开可视化工具窗口。
2. **创建节点**：点击 "Create Node" 按钮，在画布上创建新的节点。每个节点会自动命名为 `scriptX.py`，其中 `X` 是节点的编号。
3. **拖动节点**：使用鼠标中键点击并拖动节点，将其移动到所需的位置。
4. **建立依赖关系**：使用鼠标左键点击一个节点，然后拖动到另一个节点，释放鼠标左键即可建立两个脚本之间的依赖关系。
5. **执行脚本**：点击 "Execute All Files" 按钮，工具会对脚本进行拓扑排序，并按顺序执行这些脚本。如果图中存在循环依赖，工具会输出错误信息。

## 代码结构
### 全局变量
- `graph`：一个字典，用于存储节点之间的依赖关系。
- `nodes`：一个列表，用于存储画布上的所有节点。
- `node_names`：一个字典，用于存储节点的名称。
- `node_labels`：一个字典，用于存储节点的标号。
- `current_dragging`：当前正在拖动的节点。
- `start_node`：开始建立依赖关系的节点。
- `line`：用于绘制依赖关系的连线。
- `DISTANCE_THRESHOLD`：建立依赖关系的距离阈值。
- `SELECTION_THRESHOLD`：节点选中范围的阈值。

### 主要函数
1. **`topological_sort(graph)`**：对图进行拓扑排序，返回脚本的执行顺序。如果图中存在循环依赖，会抛出 `ValueError` 异常。
2. **`execute_file(file)`**：执行指定的 Python 脚本，并输出执行结果。
3. **`execute_all_files()`**：对所有脚本进行拓扑排序，并按顺序执行这些脚本。
4. **`find_node_in_range(x, y)`**：查找在指定坐标范围内的节点。
5. **`create_node()`**：创建一个新的节点，并绑定鼠标事件。
6. **`start_drag(event)`**：开始拖动节点。
7. **`drag(event)`**：拖动节点。
8. **`end_drag(event)`**：结束拖动节点。
9. **`start_connect(event)`**：开始建立依赖关系。
10. **`draw_line(event)`**：绘制依赖关系的连线。
11. **`end_connect(event)`**：结束建立依赖关系，根据距离阈值判断是否建立连接。

## 注意事项
- 确保所有的 Python 脚本文件都可以在当前环境中正常执行。
- 如果图中存在循环依赖，拓扑排序将失败，工具会输出错误信息。
- 节点的命名规则为 `scriptX.py`，其中 `X` 是节点的编号。如果需要修改节点名称，请直接修改 `node_names` 字典。

## 贡献
如果你发现任何问题或有改进建议，请随时提交 Issue 或 Pull Request。